---
- set_fact:
    mail_conf:
      uid: 2222
      gid: 2222
      user: vmail
      group: vmail
      maildir: "{{ data_dir }}/mail/vmail"
      hostname: "{{ mail.mailserver }}"
      domain: "{{ mail.mailserver | regex_search('([a-z0-9-]+\\.[a-z]+$)') }}"
      mailboxes: "{{ mail.mailboxes }}"

- set_fact:
    mail_computed:
      alias_domains: "{{ mail_conf.mailboxes | sum(attribute='aliases', start=[]) | map('regex_replace', '.*@', '') | list | unique }}"
      mailbox_domains: "{{ mail_conf.mailboxes | map(attribute='domain') | list | unique }}"

- group:
    name: "{{ mail_conf.group }}"
    gid: "{{ mail_conf.gid }}"
    state: present

- user:
    name: "{{ mail_conf.user }}"
    group: "{{ mail_conf.group }}"
    uid: "{{ mail_conf.uid }}"
    home: "{{ mail_conf.maildir }}"
    shell: /bin/false
    createhome: no

- file:
    path: "{{ mail_conf.maildir }}"
    owner: "{{ mail_conf.user }}"
    group: "{{ mail_conf.group }}"
    state: directory
    mode: "u=rwx,g=rx,o-rwx"

- file:
    path: "{{ mail_conf.maildir }}/{{ item }}"
    owner: "{{ mail_conf.user }}"
    group: "{{ mail_conf.group }}"
    state: directory
    mode: "u=rwx,g=rx,o-rwx"
  with_items: "{{ mail_computed.mailbox_domains | union(mail_computed.alias_domains) | unique | list }}"

- name: Install Postfix
  apt:
    package: "{{ item }}"
    state: installed
    force: yes
    update_cache: yes
    cache_valid_time: 3600
  with_items:
    - postfix
    - dovecot-common
    - dovecot-imapd
    - dovecot-pop3d
    - mailutils

- name: Allow mail traffic
  ufw: rule={{ item.rule }} port={{ item.port }} proto={{ item.proto }}
  with_items:
    # SMTP S2S
    - { rule: 'allow', port: '25', proto: 'tcp' }
    - { rule: 'allow', port: '2525', proto: 'tcp' }
    # POP3
    - { rule: 'allow', port: '110', proto: 'tcp' }
    - { rule: 'allow', port: '995', proto: 'tcp' }
    # IMAP
    - { rule: 'allow', port: '143', proto: 'tcp' }
    - { rule: 'allow', port: '993', proto: 'tcp' }

- name: Redirect from 2525 to 25 to circumvent firewalls
  iptables:
     table: nat
     chain: PREROUTING
     protocol: tcp
     match: tcp
     destination_port: 2525
     jump: REDIRECT
     to_ports: 25
     comment: Redirect mail traffic from 2525 to 25

- name: Configure main postfix
  template:
    src: templates/postfix-main.cf
    dest: /etc/postfix/main.cf
    mode: "u=r,g=r,o=r"
  notify:
    - restart postfix

- name: Configure virtual aliases
  template:
    src: templates/virtual_alias_maps
    dest: /etc/postfix/virtual_alias_maps
    mode: "u=r,g=r,o=r"
  notify:
    - restart dovecot

- name: Configure virtual mailboxes
  template:
    src: templates/virtual_mailbox_maps
    dest: /etc/postfix/virtual_mailbox_maps
    mode: "u=r,g=r,o=r"
  notify:
    - restart dovecot

- name: Configure dovecot
  template:
    src: templates/dovecot.conf
    dest: /etc/dovecot/dovecot.conf
    mode: "u=r,g=r,o=r"
  notify:
    - restart dovecot


- name: Configure dovecot users
  template:
    src: templates/dovecot-passwd
    dest: /etc/dovecot/passwd
    mode: "u=r,g=r,o=r"
  notify:
    - restart postfix

- name: Ensure running postfix
  service:
    name: postfix
    state: started
    enabled: yes
